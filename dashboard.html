<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artesanal Blend - Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
    
    <style>
        /* Estilos básicos para a tela de login (pode ser movido para dashboard.css) */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        /* O restante do seu CSS para o dashboard principal deve estar no dashboard.css */
    </style>
</head>
<body>

    <div id="login-screen" style="display: none;">
        <div class="login-box">
            <h2>Acesso Restrito - Dashboard</h2>
            <p>Faça login para gerenciar o cardápio.</p>
            <input type="text" id="loginUser" placeholder="Usuário" value="admin"><br><br>
            <input type="password" id="loginPass" placeholder="Senha"><br><br>
            <button id="doLoginBtn">Entrar</button>
            
        </div>
    </div>

    <div id="dashboard-content">
        <header>
            <h1>Painel de Controle Artesanal Blend</h1>
            <div class="user-info">
                Bem-vindo(a), <span id="currentUser">—</span> |
                <button id="exportBtn" title="Salvar menu.json no servidor" style="margin-right: 10px;">
                    Exportar Cardápio
                </button>
                <button id="logoutBtn" style="display: none;">
                    Sair
                </button>
            </div>
        </header>

        <main>
            <section id="stats">
                <h2>Estatísticas</h2>
                </section>

            <section id="product-form">
                <h2>Adicionar/Editar Produto</h2>
                </section>
            
            <section id="product-list">
                <h2>Cardápio Atual</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Preço</th>
                            <th>Categoria</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="menu-tbody">
                        </tbody>
                </table>
            </section>
        </main>
    </div>

    <script>
        // ==================================================================
        // VARIÁVEIS GLOBAIS
        // ==================================================================
        let produtos = []; // Array que armazena os dados do cardápio
        let logged = false;

        // Elementos do DOM (Verifique se os IDs abaixo batem com seu HTML)
        const loginModal = document.getElementById('login-screen');
        const loginUser = document.getElementById('loginUser');
        const loginPass = document.getElementById('loginPass');
        const doLoginBtn = document.getElementById('doLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentUser = document.getElementById('currentUser'); // Elemento para mostrar o usuário
        const menuTbody = document.getElementById('menu-tbody');
        
        // ==================================================================
        // FUNÇÕES DE MANIPULAÇÃO DE DADOS (CARREGAR E RENDERIZAR)
        // ==================================================================
        
        // NOVO: Função para carregar o menu usando a API segura
        async function loadMenu() {
            try {
                // Chamada à nova API segura
                const response = await fetch("/api/menu", { cache: "no-store" });
                
                if (!response.ok) {
                    throw new Error(`Erro ao carregar cardápio. Status: ${response.status}`);
                }

                produtos = await response.json(); 
                render(); 
            } catch (e) {
                console.error("Erro ao carregar cardápio:", e);
                produtos = []; 
                render();
                alert("❌ Erro ao carregar cardápio do servidor. Verifique o console.");
            }
        }
        
        // Função para renderizar a lista de produtos na tabela
        function render() {
            menuTbody.innerHTML = '';
            if (produtos.length === 0) {
                menuTbody.innerHTML = '<tr><td colspan="5">Nenhum produto cadastrado.</td></tr>';
                return;
            }

            produtos.forEach(p => {
                const row = menuTbody.insertRow();
                row.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.name}</td>
                    <td>R$ ${p.price.toFixed(2)}</td>
                    <td>${p.cat}</td>
                    <td>
                        <button onclick="editP(${p.id})">Editar</button>
                        <button onclick="delP(${p.id})">Excluir</button>
                    </td>
                `;
            });
            // Você pode chamar a função de estatísticas aqui: updateStats();
        }

        // Exemplo de função de edição (você deve ter a sua)
        function editP(id) {
            alert(`Função Editar Produto ${id} (Implementar lógica do formulário)`);
            // Lógica para carregar os dados do produto no formulário de edição
        }

        // Exemplo de função de exclusão (você deve ter a sua)
        function delP(id) {
            if (confirm(`Tem certeza que deseja excluir o produto ID ${id}?`)) {
                produtos = produtos.filter(p => p.id !== id);
                render();
                alert('Produto excluído localmente. Não se esqueça de EXPORTAR!');
            }
        }
        
        // ... (Mantenha todas as suas outras funções aqui: updateStats, saveProduct, etc.) ...
        
        // ==================================================================
        // LÓGICA DE SEGURANÇA (API COM SESSÃO)
        // ==================================================================

        // Função para verificar se o usuário está logado (chamada ao iniciar)
        async function checkStatus() {
            // Verifica a existência do cookie. O servidor garante que ele é assinado/seguro.
            if (document.cookie.includes('auth_session')) {
                logged = true;
                loginModal.style.display = "none";
                // Assumindo que você quer mostrar "admin" após o login
                currentUser.innerText = "admin"; 
                logoutBtn.style.display = "inline-block";
                loadMenu(); // Carrega o cardápio se a sessão estiver ativa
            } else {
                loginModal.style.display = "flex";
            }
        }

        // Evento de Login que chama a API
        doLoginBtn.onclick = async () => {
            const user = loginUser.value;
            const pass = loginPass.value;

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user, pass })
                });
                
                const data = await response.json();

                if (data.success) {
                    logged = true;
                    currentUser.innerText = user; 
                    loginModal.style.display = "none";
                    logoutBtn.style.display = "inline-block";
                    loadMenu(); 
                    alert('Login efetuado com sucesso!');
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Erro de conexão ao tentar logar com o servidor.');
            }
        };

        // Evento de Logout que chama a API
        logoutBtn.onclick = async () => {
            try {
                await fetch('/api/logout', { method: 'POST' });
                logged = false;
                currentUser.innerText = "—";
                logoutBtn.style.display = "none";
                loginModal.style.display = "flex";
                alert('Você saiu do painel.');
            } catch (error) {
                alert('Erro ao fazer logout, mas a sessão local foi encerrada.');
            }
        };

        // Evento de Exportação que usa a Sessão (não envia token)
        document.getElementById("exportBtn").onclick = async () => {
            if (!logged) {
                alert("Você precisa estar logado para exportar para o servidor.");
                return;
            }

            if (!confirm("Tem certeza que deseja ATUALIZAR o menu.json no servidor?")) return;

            try {
                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // O cookie de sessão é enviado automaticamente!
                    },
                    // Mapeie e envie seus produtos (Ajuste o mapeamento se o menu.json tiver mais campos!)
                    body: JSON.stringify(produtos.map(p => ({
                        id: p.id, 
                        name: p.name, 
                        desc: p.desc,
                        price: p.price, 
                        cat: p.cat, 
                        imgUrl: p.imgUrl 
                    }), null, 2)),
                });

                const data = await response.json();

                if (response.status === 401) {
                     alert(`❌ Erro de Autorização. Sessão expirou. Faça login novamente.`);
                } else if (data.success) {
                    alert(`✅ Sucesso! ${data.message}`);
                } else {
                    alert(`❌ Erro ao exportar: ${data.message}`);
                }
            } catch (error) {
                console.error('Erro na requisição de exportação:', error);
                alert('❌ Erro de conexão com o servidor.');
            }
        };

        // Inicializa a verificação de status (deve ser a última coisa a ser chamada)
        checkStatus();

    </script>
</body>
</html>


